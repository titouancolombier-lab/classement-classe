<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Classement Elo de la classe</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    header {
      background: #222;
      color: white;
      padding: 15px 0;
      margin-bottom: 20px;
    }
    h1 {
      margin: 0;
      font-size: 24px;
    }

    /* DUEL */
    #duel-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      width: 200px;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    .avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 10px;
    }

    .name {
      font-size: 18px;
      margin-bottom: 10px;
    }
    .elo {
      font-size: 14px;
      color: #555;
    }

    #ranking {
      max-width: 400px;
      margin: 40px auto;
      text-align: left;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    #ranking h2 {
      margin-top: 0;
    }

    #ranking ol {
      padding-left: 20px;
    }

    #ranking li {
      margin-bottom: 5px;
    }

    #status {
      margin-top: 15px;
      color: #555;
      font-size: 14px;
    }

    button {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      background: #222;
      color: white;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background: #444;
    }

    #admin-link {
      position: fixed;
      bottom: 10px;
      right: 10px;
      font-size: 12px;
    }
    #admin-link a {
      color: #555;
      text-decoration: none;
    }
    #admin-link a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <header>
    <h1>Classement Elo de la classe</h1>
  </header>

  <!-- DUEL -->
  <div id="duel-container">
    <div id="cardA" class="card">
      <img id="avatarA" class="avatar" src="default-avatar.png" alt="Avatar A" />
      <div class="name" id="nameA">...</div>
      <div class="elo" id="eloA"></div>
    </div>

    <div id="cardB" class="card">
      <img id="avatarB" class="avatar" src="default-avatar.png" alt="Avatar B" />
      <div class="name" id="nameB">...</div>
      <div class="elo" id="eloB"></div>
    </div>
  </div>

  <div id="status"></div>

  <button id="skip">Passer ce duel</button>

  <!-- CLASSEMENT TOP 3 -->
  <div id="ranking">
    <h2>Top 3</h2>
    <ol id="ranking-list"></ol>
  </div>

  <div id="admin-link">
    <a href="/admin.html">Admin</a>
  </div>

  <script>
    const API_URL = "http://localhost:3000/api";

    let currentPair = [];

    const cardA = document.getElementById("cardA");
    const cardB = document.getElementById("cardB");
    const nameA = document.getElementById("nameA");
    const nameB = document.getElementById("nameB");
    const eloA = document.getElementById("eloA");
    const eloB = document.getElementById("eloB");
    const avatarA = document.getElementById("avatarA");
    const avatarB = document.getElementById("avatarB");
    const statusDiv = document.getElementById("status");
    const rankingList = document.getElementById("ranking-list");
    const skipBtn = document.getElementById("skip");

    const DEFAULT_AVATAR = "default-avatar.png";

    async function loadPair() {
      statusDiv.textContent = "Chargement du duel...";
      try {
        const res = await fetch(API_URL + "/pair");
        const data = await res.json();

        currentPair = data;

        nameA.textContent = data[0].name;
        nameB.textContent = data[1].name;

        eloA.textContent = "Elo : " + Math.round(data[0].elo);
        eloB.textContent = "Elo : " + Math.round(data[1].elo);

        avatarA.src = data[0].avatar || DEFAULT_AVATAR;
        avatarB.src = data[1].avatar || DEFAULT_AVATAR;

        statusDiv.textContent = "Clique sur la personne que tu prÃ©fÃ¨res ðŸ‘‡";
      } catch (err) {
        console.error(err);
        statusDiv.textContent = "Erreur lors du chargement du duel.";
      }
    }

    async function loadRanking() {
      try {
        const res = await fetch(API_URL + "/students?limit=3"); // top 3 seulement
        const data = await res.json();

        rankingList.innerHTML = "";

        data.forEach((student, index) => {
          const li = document.createElement("li");
          li.textContent = `${index + 1}. ${student.name} (Elo: ${Math.round(student.elo)})`;
          rankingList.appendChild(li);
        });
      } catch (err) {
        console.error(err);
        statusDiv.textContent = "Erreur lors du chargement du classement.";
      }
    }

    async function vote(winnerIndex) {
      if (currentPair.length !== 2) return;

      const winner = currentPair[winnerIndex];
      const loser = currentPair[1 - winnerIndex];

      statusDiv.textContent = `Tu as votÃ© pour ${winner.name}... mise Ã  jour du classement`;

      try {
        await fetch(API_URL + "/vote", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            winnerId: winner.id,
            loserId: loser.id,
          }),
        });

        await loadPair();
        await loadRanking();
      } catch (err) {
        console.error(err);
        statusDiv.textContent = "Erreur lors de l'envoi du vote.";
      }
    }

    cardA.addEventListener("click", () => vote(0));
    cardB.addEventListener("click", () => vote(1));
    skipBtn.addEventListener("click", () => {
      loadPair();
    });

    loadPair();
    loadRanking();
  </script>
</body>
</html>
